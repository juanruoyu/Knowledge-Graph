<html>
    <title>Graph</title>

    <style>
         .Mytext{
            text-anchor: middle;
            font-family: arial;
            font-size: 1px;
            }
        .Edge {
                stroke: #777;
                stroke-opacity: .2;
            }
        
        #right_select_box {
                line-height:30px;
                background-color:#eeeeee;
                height:900px;
                width:300px;
                float:right;
                padding:10px;	      
            }
    </style>
    
    <script src="https://cdn.staticfile.org/angular.js/1.4.6/angular.min.js"></script>
    <script src="lib/d3.v3.min.js" charset="utf-8"></script>


    <body >
        <link rel="stylesheet" href="lib/style/bootstrap.min.css">

    
        <nav class="navbar nav-default" role="navigation" style="background-color: grey; max-height: 60px;">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">
                    <p style="color: white"> Knowlege Graph </p></a>
            </div>
            <div>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://vis.cse.ust.hk/"  style="color: #ffffff">About Us</a></li>
                    <li><a href="#"  style="color: #ffffff">Help</a></li>
                </ul>
            </div>
        </nav>
        
        <div id="right_select_box">
            <div id= "col-sm-3 col-sm-offset-9 col-md-3 col-md-offset-9 sidebar" ng-class="{invisible: uiConfig.hideControlPanel}">
                <script src="scripts/controller/rightCtrl.js"></script>
                <!-- <div ng-app="myApp" ng-controller="rightCtrl">
 
                        cc:<input type="text" ng-model="input1"><br>
                        jry: <input type="text" ng-model="lastName"><br>
                        <br>
                        姓名: {{output()}}
                         
                </div>     -->
  
                <div ng-include src="'views/rightSidebar.html'" class="ng-scope">rightSidebar</div>
                    <!-- need add rightctrl function ---------------------->
                <div id="right-sidebar" ng-controller="rightCtrl" class="ng-scope"> rightCtrl</div>
                    <h4>Control Panel:</h4>
                    <div ng-include src="'views/queryFilter.html'" class="ng-scope"></div>
                    <div id="queryFilter" ng-controller="queryFilterCtrl" class="ng-scope">
                        <div class="info-header">
                            <h5> Querys:</h5>
                        </div>
                        <div ng-if="dataLoadFlag == 1" class="ng-scope">
                            <div id="searchWrapper" class="queryWarpper">
                                <input type="text" class="form-control ng-pristine ng-untouched ng-valid" placeholder="Graph node name" style="width:63%;display:inline" ng-model="querData.searchText">
                                <button type="button" class="btn btn-primary" style="display: inline" ng-click="search()"> Search</button>
                                <button type="button" class="btn btn-primary" style="display: inline" ng-click="reset()"> Reset</button>
                            </div>
                        </div>
                    </div>  
                    <div>
                        <!-- need to add tablectrl  highlight-node-->
                        <div table-directive table-config ="tableConfig" table-data="currentNodes" ng-controller="tableCtrl" highlight-node="highlightNode(node)" class="ng-score ng-isolate-scope"> 
                            <div id = "table-section">
                                <div class="info-header">
                                    <h5>Graph Nodes List:</h5>
                                </div>
                                <div class="table-view ng-scope" ng-if="tableData !=undefined" >
                                    <table class="table table-bordered table-condensed">
                                        <thead>
                                            <tr>
                                                <th ng-style="{'width':tableConfig.thNodeWidth * 100 +'%'}" colspan="1" style="width:100%;text-align:center" >Nodes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat= "node in tableData" class="selectable ng-scope" ng-click="highlightNode({node.node})">
                                                <td  ng-app="myApp3" ng-init="graphnode1='Function'" ng-controller="cc">
                                                    <p> Node Name: {{graphnode1}} <span style="font-size:18px;font-weight:bold;text-align:right"></span> </p>  
                                                    <p> Node Name: {{graphnode2}} <span style="font-size:18px;font-weight:bold;text-align:right"></span> </p>  
                                                    <p> Node Name: {{graphnode3}} <span style="font-size:18px;font-weight:bold;text-align:right"></span> </p>  
                                                    <p> Node Name: {{graphnode4}} <span style="font-size:18px;font-weight:bold;text-align:right"></span> </p>  
                                                    <p> Node Name: {{graphnode5}} <span style="font-size:18px;font-weight:bold;text-align:right"></span> </p>  

                                                </td>
                                                
                                            <script> 
                                                //global_datas = JSON.parse(localStorage.getItem("global_datas"));
                                                //console.log(global_datas)
                                                var app = angular.module('myApp3', []);
                                                    app.controller('cc', function($scope) {
                                                        //$scope.graphnode2 =global_datas.nodes[0]
                                                        global_datas = JSON.parse(localStorage.getItem("global_datas"));
                                                        

                                                        $scope.graphnode1 = "John";
                                                        $scope.graphnode2 = global_datas.nodes[0].name;
                                                        $scope.graphnode3 = global_datas.nodes[1].name;
                                                        $scope.graphnode4 = global_datas.nodes[2].name;
                                                        $scope.graphnode5 = global_datas.nodes[3].name;

                                                    });     
                                            </script>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="name-box-d3"></div>
                        </div>
                    </div>

                    
            </div>
        </div>  

        <script src="lib/jquery-1.9.1.js"></script>

        <script src="main.js"></script>
        <script src="scripts/controller/rightCtrl.js"></script>
        
        <script>
            //数据更新
            function update(){
                var datas = JSON.parse(localStorage.getItem("global_datas"));
                var edges = []//datas.edges;
                var nodes = []//datas.nodes;//['a', 'b', 'c'];
                // nn = ["a","b","c","d","e"]
                console.log("without push",nodes.length,edges.length)
                for(var j=0 ;j<5; j++){
                    nodes.push(datas.nodes[j])    
                    edges.push({
                            "source":Math.ceil(Math.random() * (nodes.length - 1) ),
                            "target":Math.ceil(Math.random() * (nodes.length - 1) ),
                    })
                }
                console.log("push", nodes.length,edges.length)
                d = {"nodes":nodes,"edges":edges}               
                Show_select_Points(d);

            }
            //增加数据
            function recover(){
                var datas = JSON.parse(localStorage.getItem("global_datas"));
                d = {"nodes":datas.nodes,"edges":datas.edges}               
                Show_select_Points(d);
                //visiual(datas)

                // for (var i =0; i<10;i++){
                //     dataset.push({
                //         x:Math.random()*100,
                //         y:Math.random()*100
                //     });
                // }
                // updatePoints();
            }
            function decrease(){
                var edges = []//datas.edges;
                var nodes = []//datas.nodes;//['a', 'b', 'c'];
                
                dempty = {"nodes":[],"edges":[]}
                Show_select_Points(dempty);
                
            }
            

            function Show_select_Points(dataset){
                var svg = d3.selectAll("svg")

                var force = d3.layout.force()
                    .nodes(dataset.nodes) //指定节点数组
                    .links(dataset.edges) //指定连线数组
                    .size([1100,1080]) //指定作用域范围
                    .linkDistance(60) //指定连线长度
                    .charge([-400]); //相互之间的作用力;
                    force.start();
                
                //绑定数据
                var update_lines = svg.selectAll("line")
                    .data(dataset.edges);
                var update_nodes = svg.selectAll('circle')
                    .data(dataset.nodes);
                var update_texts = svg.selectAll("text")
                    .data(dataset.nodes)
                console.log('test',dataset)
                
                //绑定数据后，分别获取update和enter部分
                var enter_lines = update_lines.enter();
                var exit_lines = update_lines.exit();
                var enter_nodes = update_nodes.enter();
                var exit_nodes = update_nodes.exit();
                var enter_texts = update_texts.enter();
                var exit_texts = update_texts.exit();

                offset = "translate(10,-100)"
                //有新数据没有足够的元素，插入新元素，并将元素赋予新的数据,enter部分的处理方法是添加元素后再修改内容
                enter_lines.append("line")
                    .attr("stroke",1000)
                    .attr("class","Edge")
                    .attr("transform",offset)
                    .attr("x1",function(d){ return d.source.x; })
                    .attr("y1",function(d){ return d.source.y; })
                    .attr("x2",function(d){ return d.target.x; })
                    .attr("y2",function(d){ return d.target.y; })
                
                var color = d3.scale.category20();
                enter_nodes.append("circle")                  
                    .style("fill",function(d,i){
                        return color(i);
                    })
                    .attr("transform",offset)
                    .attr("r",5)
                    .style("stroke-width", 1)
                    .attr("cx",function(d){return d.x;})
                    .attr("cy",function(d){return d.y;})

                    
                enter_nodes.append("text")
                    .attr("transform",offset)
                    .style("fill", "black")
                    .attr("dx", 20)
                    .attr("dy", 8)
                    .attr("font-size","10px")
                    .text(function(d){
                        return d.name;
                    })
                    .style("fill-opacity", 1)
                    .attr("x",function(d){return d.x;})
                    .attr("y",function(d){return d.y;})

                //只更新xy坐标
                update_lines.transition()
                update_nodes.transition()
                update_texts.transition()  
                
                //减少了数据，数据小于元素（图形），删除元素就行
                exit_lines.attr("fill-opacity",1.0)
                    .transition()
                    .duration(1000)
                    .attr("fill-opacity",0.0)
                    
                exit_nodes.attr("fill-opacity",1.0)
                    .transition()
                    .duration(1000)
                    .attr("fill-opacity",0.0)
                
                exit_texts.attr("fill-opacity",1.0)
                    .transition()
                    .duration(1000)
                    .attr("fill-opacity",0.0)
                    //.attr('cx',function(d){return XScale(0)})
                    //.attr('cy',function(d){return YScale(0)});
                    
                //remove;
                //exit部分的处理方法是删除
                exit_lines.remove();
                exit_nodes.remove();
                exit_texts.remove();

            }

        </script>
        <button onclick="update()">update</button>
        <button onclick="recover()">recover</button>
        <button onclick="decrease()">decrease</button>

    </body>
</html>